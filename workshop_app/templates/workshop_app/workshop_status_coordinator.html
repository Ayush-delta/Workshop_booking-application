{% extends "workshop_app/base.html" %}

{% block title %}
    My Workshops
{% endblock %}

{% block content %}
<div class="container">
    <!-- Minimal high-impact toolbar: search + status filter -->
    <div class="toolbar fade-in">
        <div class="filters">
            <select id="status-filter" class="form-control form-control-sm" style="width: 180px;">
                <option value="">All statuses</option>
                <option value="accepted">Accepted</option>
                <option value="proposed">Proposed</option>
            </select>
        </div>
        <input id="search-input" class="form-control form-control-sm search-input" type="search" placeholder="Search by type, instructor, date...">
    </div>
    <div class="row mb-4 fade-in">
        <div class="col-12">
            <div class="hero-section text-center p-4 rounded" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                <h1>Welcome, {{ user.first_name }}!</h1>
                <p class="lead">Manage your workshops and stay updated on your proposals. Quick links below.</p>
            </div>
        </div>
    </div>

    <!-- Quick Links -->
    <div class="row mb-4 fade-in">
        <div class="col-md-4 mb-3">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <i class="fas fa-plus-circle fa-2x text-accent mb-2"></i>
                    <h5>Propose Workshop</h5>
                    <a href="{% url 'workshop_app:propose_workshop' %}" class="btn btn-primary">Start Proposing</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <i class="fas fa-list fa-2x text-accent mb-2"></i>
                    <h5>Workshop Types</h5>
                    <a href="{% url 'workshop_app:workshop_type_list' %}" class="btn btn-primary">Browse Types</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <i class="fas fa-bell fa-2x text-accent mb-2"></i>
                    <h5>Notifications</h5>
                    <p>No new notifications. Check back soon!</p>
                </div>
            </div>
        </div>
    </div>

    {% if not workshops %}
        <div class="row fade-in">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-calendar-plus fa-3x text-light mb-3"></i>
                        <h3>Get Started</h3>
                        <p>Propose your first workshop to see details here. Head to the Propose Workshop section.</p>
                        <a href="{% url 'workshop_app:propose_workshop' %}" class="btn btn-accent">Propose Now</a>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Accepted Workshops -->
        <div class="row mb-5 fade-in">
            <div class="col-12">
                <h2 class="text-center mb-4">Accepted Workshops</h2>
                <div class="row" id="accepted-list">
                    {% for workshop in workshops %}
                        {% if workshop.status %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">{{ workshop.workshop_type|capfirst }}</h5>
                                        {% if workshop.workshop_uid %}
                                        <button class="copy-btn text-white" title="Copy UID" data-uid="{{ workshop.workshop_uid }}">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text searchable"><strong>Date:</strong> {{ workshop.date|date }}</p>
                                        <p class="card-text searchable"><strong>Instructor:</strong> {{ workshop.instructor.get_full_name }}</p>
                                        <span class="badge-status accepted">{{ workshop.get_status }}</span>
                                    </div>
                                    <div class="card-footer">
                                        <a href="{% url 'workshop_app:workshop_details' workshop.id %}" class="btn btn-primary btn-sm">View Details</a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% empty %}
                        <div class="col-12">
                            <p class="text-center">No accepted workshops yet.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Proposed Workshops -->
        <div class="row fade-in">
            <div class="col-12">
                <h2 class="text-center mb-4">Proposed Workshops</h2>
                <div class="row" id="proposed-list">
                    {% for workshop in workshops %}
                        {% if not workshop.status and workshop.tnc_accepted %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-warning text-dark">
                                        <h5>{{ workshop.workshop_type|capfirst }}</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text searchable"><strong>Date:</strong> {{ workshop.date|date }}</p>
                                        <span class="badge-status proposed">{{ workshop.get_status }}</span>
                                    </div>
                                    <div class="card-footer">
                                        <a href="{% url 'workshop_app:workshop_details' workshop.id %}" class="btn btn-primary btn-sm">View Details</a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% empty %}
                        <div class="col-12">
                            <p class="text-center">No proposed workshops.</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const acceptedList = document.getElementById('accepted-list');
    const proposedList = document.getElementById('proposed-list');

    function normalize(text) {
        return (text || '').toLowerCase();
    }

    function cardMatchesSearch(card, query) {
        if (!query) return true;
        const title = card.querySelector('h5')?.innerText || '';
        const searchable = Array.from(card.querySelectorAll('.searchable')).map(e => e.innerText).join(' ');
        return normalize(title + ' ' + searchable).includes(normalize(query));
    }

    function filterCards() {
        const q = searchInput.value.trim();
        const status = statusFilter.value; // '', 'accepted', 'proposed'

        function apply(listEl) {
            if (!listEl) return;
            const cols = listEl.querySelectorAll('.col-md-6.col-lg-4');
            cols.forEach(col => {
                const card = col.querySelector('.card');
                const isAccepted = listEl.id === 'accepted-list';
                const statusOk = !status || (status === 'accepted' && isAccepted) || (status === 'proposed' && !isAccepted);
                const searchOk = cardMatchesSearch(card, q);
                col.style.display = (statusOk && searchOk) ? '' : 'none';
            });
        }

        apply(acceptedList);
        apply(proposedList);
    }

    searchInput && searchInput.addEventListener('input', filterCards);
    statusFilter && statusFilter.addEventListener('change', filterCards);

    // Copy UID buttons
    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const uid = btn.getAttribute('data-uid');
            if (!uid) return;
            navigator.clipboard.writeText(uid).then(() => {
                toastr && toastr.success('Workshop UID copied to clipboard');
            }).catch(() => {
                toastr && toastr.error('Failed to copy UID');
            });
        });
    });
});
</script>
{% endblock %}
